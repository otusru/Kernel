# üß© –ú–û–î–£–õ–¨ 5: –ú–æ–¥—É–ª–∏ —è–¥—Ä–∞ Linux (LKM) ‚Äî –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —è–¥—Ä–∞

---

## üéØ –¶–µ–ª—å –º–æ–¥—É–ª—è:

* –ü–æ–Ω—è—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–µ –º–æ–¥—É–ª—å —è–¥—Ä–∞ –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω;
* –ù–∞–ø–∏—Å–∞—Ç—å, —Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥—É–ª—å (–¥—Ä–∞–π–≤–µ—Ä);
* –ü–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –º–æ–¥—É–ª—è (init, exit);
* –û—Å–≤–æ–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, —Ä–∞–±–æ—Ç—ã —Å `/proc` –∏ `/dev`.

---

## üß† –ß—Ç–æ —Ç–∞–∫–æ–µ LKM?

**Loadable Kernel Module (LKM)** ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å** –∏ –≤—ã–≥—Ä—É–∂–∞—Ç—å –≤ —è–¥—Ä–æ Linux –±–µ–∑ –µ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

### –ü—Ä–∏–º–µ—Ä—ã:

* –î—Ä–∞–π–≤–µ—Ä —Å–µ—Ç–µ–≤–æ–π –∫–∞—Ä—Ç—ã
* –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

---

## üß™ –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –º–æ–¥—É–ª—å —è–¥—Ä–∞

### üìÅ –§–∞–π–ª: `hello.c`

```c
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("–¢—ã");
MODULE_DESCRIPTION("–ü—Ä–æ—Å—Ç–æ–π –º–æ–¥—É–ª—å —è–¥—Ä–∞");

static int __init hello_init(void) {
    printk(KERN_INFO "–ü—Ä–∏–≤–µ—Ç –∏–∑ —è–¥—Ä–∞!\n");
    return 0;
}

static void __exit hello_exit(void) {
    printk(KERN_INFO "–ü–æ–∫–∞, —è–¥—Ä–æ!\n");
}

module_init(hello_init);
module_exit(hello_exit);
```

---

### üõ† Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏

```makefile
obj-m += hello.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
```

---

### üîß –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
make                      # —Å–±–æ—Ä–∫–∞
sudo insmod hello.ko      # –∑–∞–≥—Ä—É–∑–∫–∞
dmesg | tail              # –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–∞ —è–¥—Ä–∞
sudo rmmod hello          # –≤—ã–≥—Ä—É–∑–∫–∞
```

---

## üß™ –ü—Ä–∏–º–µ—Ä 2: –ú–æ–¥—É–ª—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```c
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

static int value = 0;
module_param(value, int, 0); // –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
MODULE_PARM_DESC(value, "–¶–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä");

static int __init mod_init(void) {
    printk(KERN_INFO "–ó–Ω–∞—á–µ–Ω–∏–µ value = %d\n", value);
    return 0;
}

static void __exit mod_exit(void) {
    printk(KERN_INFO "–í—ã—Ö–æ–¥ –∏–∑ –º–æ–¥—É–ª—è\n");
}

module_init(mod_init);
module_exit(mod_exit);
MODULE_LICENSE("GPL");
```

–ó–∞–≥—Ä—É–∑–∏—Ç—å:

```bash
sudo insmod modparam.ko value=42
```

---

## üß™ –ü—Ä–∏–º–µ—Ä 3: –ü—Ä–æ—Å—Ç–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ `/proc`

```c
#include <linux/proc_fs.h>
#include <linux/uaccess.h>

#define ENTRY_NAME "myproc"
static struct proc_dir_entry *entry;

ssize_t read_proc(struct file *file, char __user *buf, size_t count, loff_t *ppos) {
    char *msg = "Hello from /proc!\n";
    return simple_read_from_buffer(buf, count, ppos, msg, strlen(msg));
}

static struct file_operations fops = {
    .owner = THIS_MODULE,
    .read = read_proc,
};

static int __init proc_init(void) {
    entry = proc_create(ENTRY_NAME, 0, NULL, &fops);
    return 0;
}

static void __exit proc_exit(void) {
    proc_remove(entry);
}

module_init(proc_init);
module_exit(proc_exit);
MODULE_LICENSE("GPL");
```

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è:

```bash
cat /proc/myproc
```

---

## üß† –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                    |
| --------------- | --------------------------------------------- |
| `module_init()` | –§—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ              |
| `module_exit()` | –§—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ              |
| `printk()`      | –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∞–Ω–∞–ª–æ–≥ `printf()` –≤ user space) |
| `MODULE_‚Ä¶`      | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —è–¥—Ä–∞                           |
| `Makefile`      | –°–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ `kbuild`                         |

---

## üß† –ì–¥–µ –º–æ–¥—É–ª—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ?

* –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏: `lsmod`
* –ñ—É—Ä–Ω–∞–ª —è–¥—Ä–∞: `dmesg`
* –§–∞–π–ª —É—Å—Ç—Ä–æ–π—Å—Ç–≤: `/proc/devices`, `/proc/modules`
* –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: `/dev/`, `/sys/class/`

---

## üì¶ –ü—Ä–∞–∫—Ç–∏–∫–∞

1. –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π:

   * –°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –≤ `/proc/`;
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞;
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏;
2. –ü–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π —Å `module_param()` ‚Äî –ø–µ—Ä–µ–¥–∞–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ;
3. –ü–æ—Å–º–æ—Ç—Ä–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏:

   ```bash
   modinfo e1000e
   ```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –º–æ–¥—É–ª—è:

* –¢—ã –∑–Ω–∞–µ—à—å, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–¥—É–ª–∏ —è–¥—Ä–∞;
* –£–º–µ–µ—à—å –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏ –≤—ã–≥—Ä—É–∂–∞—Ç—å LKM;
* –ü–æ–Ω–∏–º–∞–µ—à—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ–∂–¥—É user –∏ kernel space —á–µ—Ä–µ–∑ `/proc`;
* –ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî **—Å–æ–∑–¥–∞–Ω–∏—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–¥—Ä–∞ –û–° —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π** (–ú–æ–¥—É–ª—å 6).
