# üß† –ú–û–î–£–õ–¨ 7: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∏—Å—Ç–µ–º —è–¥—Ä–∞ ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –ø–∞–º—è—Ç—å, –¥—Ä–∞–π–≤–µ—Ä—ã

---

## üéØ –¶–µ–ª—å –º–æ–¥—É–ª—è:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π **–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á** (–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å);
* –ù–∞–ø–∏—Å–∞—Ç—å **—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é**: —Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è;
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å **–æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (IRQ)** –∏ **–¥—Ä–∞–π–≤–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, —Ç–∞–π–º–µ—Ä)**;
* –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —è–¥—Ä–æ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–≤–æ–¥ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã.

---

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —è–¥—Ä–∞ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ

```text
mykernel/
‚îú‚îÄ‚îÄ kernel/
‚îÇ   ‚îú‚îÄ‚îÄ main.c             ‚Üê –∑–∞–ø—É—Å–∫ —è–¥—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ memory/            ‚Üê –∞–ª–ª–æ–∫–∞—Ç–æ—Ä—ã, –∫–∞—Ä—Ç–∞ –ø–∞–º—è—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ sched/             ‚Üê –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
‚îÇ   ‚îú‚îÄ‚îÄ drivers/           ‚Üê —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: timer, keyboard
‚îÇ   ‚îî‚îÄ‚îÄ isr/               ‚Üê –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (ISR/IRQ)
‚îú‚îÄ‚îÄ lib/                   ‚Üê memset, memcpy, string
‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îú‚îÄ‚îÄ kernel.h           ‚Üê API —è–¥—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ memory.h
‚îÇ   ‚îú‚îÄ‚îÄ isr.h
‚îÇ   ‚îî‚îÄ‚îÄ sched.h
```

---

## üîπ –ß–∞—Å—Ç—å 1: –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (cooperative multitasking)

### –ß—Ç–æ –Ω—É–∂–Ω–æ:

* –ü—Ä–æ—Å—Ç–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (task queue);
* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—Ä—É—á–Ω—É—é;
* `task_create(func)` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å;
* `schedule()` ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É.

```c
typedef struct task {
    uint32_t *stack;
    void (*entry_point)(void);
    struct task *next;
} task_t;

task_t *current_task;
task_t *task_queue;
```

### –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á:

```c
void task1() {
    while (1) print("Task 1\n");
}
void task2() {
    while (1) print("Task 2\n");
}
```

---

## üîπ –ß–∞—Å—Ç—å 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### –≠—Ç–∞–ø—ã:

1. **–§–∏–∑–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å**:

   * –ë–∏—Ç–º–∞–ø –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Ñ—Ä–µ–π–º–æ–≤;
   * `alloc_frame()`, `free_frame()`.

2. **–°—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –ø–∞–º—è—Ç—å (paging)**:

   * –¢–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü (page table);
   * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ `CR3`.

```c
// page_entry_t, page_directory_t
void paging_init();
void map_page(uint32_t virt, uint32_t phys);
```

3. **–ê–ª–ª–æ–∫–∞—Ç–æ—Ä —è–¥—Ä–∞ (heap)**:

   * –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è malloc/free:

     * bump allocator
     * buddy system

---

## üîπ –ß–∞—Å—Ç—å 3: –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (IRQ, ISR)

### –ß—Ç–æ –Ω—É–∂–Ω–æ:

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å IDT (—Ç–∞–±–ª–∏—Ü—É –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π);
2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ISR (0‚Äì31) –∏ IRQ (32‚Äì47);
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ —Ç–∞–π–º–µ—Ä–∞.

```c
void isr_install();        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö ISR
void irq_install();        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è IRQ + –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ PIC
void irq_set_handler(int n, handler_func);
```

### –ü—Ä–∏–º–µ—Ä: —Ç–∞–π–º–µ—Ä

```c
void timer_callback() {
    ticks++;
    schedule(); // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–¥–∞—á
}
```

---

## üîπ –ß–∞—Å—Ç—å 4: –î—Ä–∞–π–≤–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤–≤–æ–¥/–≤—ã–≤–æ–¥)

### –¢–∞–π–º–µ—Ä (IRQ0)

```c
void timer_init(uint32_t frequency) {
    // –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PIT —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç—ã 0x40, 0x43
}
```

### –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (IRQ1)

```c
void keyboard_handler() {
    uint8_t scancode = inb(0x60);
    print(scancode_to_ascii(scancode));
}
```

---

## üîπ –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –û–° —Å –∑–∞–¥–∞—á–∞–º–∏ –∏ –≤–≤–æ–¥–æ–º

```c
void kernel_main() {
    isr_install();         // –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
    irq_install();         // IRQ + PIC
    timer_init(50);        // 50 –ì—Ü
    keyboard_install();    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
    paging_init();         // –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å
    heap_init();           // –∞–ª–ª–æ–∫–∞—Ç–æ—Ä

    task_create(task1);
    task_create(task2);
    while (1);
}
```

---

## üìò –ß—Ç–æ –∏–∑—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

* [Paging (OSDev)](https://wiki.osdev.org/Paging)
* [Task Switching (OSDev)](https://wiki.osdev.org/Task_Switching)
* [Interrupts (OSDev)](https://wiki.osdev.org/Interrupts)
* [Keyboard Driver (OSDev)](https://wiki.osdev.org/PS2_Keyboard)

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–¥—É–ª—è:

* –¢—ã –ø–æ—Å—Ç—Ä–æ–∏–ª **—è–¥—Ä–æ, —Å–ø–æ—Å–æ–±–Ω–æ–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á**;
* –£ —Ç–µ–±—è –µ—Å—Ç—å **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å** –∏ **–∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏**;
* –†–∞–±–æ—Ç–∞–µ—Ç **–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –≤–≤–æ–¥ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**;
* –¢—ã –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É: **—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º**.

---
